From d391343eaaf40334343a17d3e64dca08fe8886b1 Mon Sep 17 00:00:00 2001
From: thecozies <collinpferguson@gmail.com>
Date: Tue, 20 Jul 2021 18:25:00 -0500
Subject: [PATCH 1/4] Added patch option to Makefile

---
 .gitmodules    | 3 +++
 Makefile       | 7 ++++++-
 tools/Flips    | 1 +
 tools/Makefile | 6 +++++-
 4 files changed, 15 insertions(+), 2 deletions(-)
 create mode 100644 .gitmodules
 create mode 160000 tools/Flips

diff --git a/.gitmodules b/.gitmodules
new file mode 100644
index 00000000..4d32300c
--- /dev/null
+++ b/.gitmodules
@@ -0,0 +1,3 @@
+[submodule "tools/Flips"]
+	path = tools/Flips
+	url = git@github.com:Alcaro/Flips.git
diff --git a/Makefile b/Makefile
index 56dbaabb..126ab9f8 100644
--- a/Makefile
+++ b/Makefile
@@ -432,6 +432,7 @@ AIFF_EXTRACT_CODEBOOK := $(TOOLS_DIR)/aiff_extract_codebook
 VADPCM_ENC            := $(TOOLS_DIR)/vadpcm_enc
 EXTRACT_DATA_FOR_MIO  := $(TOOLS_DIR)/extract_data_for_mio
 SKYCONV               := $(TOOLS_DIR)/skyconv
+FLIPS                 := $(TOOLS_DIR)/Flips/flips
 ifeq ($(GZIPVER),std)
 GZIP                  := gzip
 else
@@ -495,6 +496,10 @@ load: $(ROM)
 
 libultra: $(BUILD_DIR)/libultra.a
 
+patch:
+	@$(MAKE) -C $(TOOLS_DIR) flips
+	$(FLIPS) --create --bps ./baserom.$(VERSION).z64 $(ROM) $(BUILD_DIR)/$(TARGET_STRING).bps
+
 # Extra object file dependencies
 $(BUILD_DIR)/asm/boot.o:              $(IPL3_RAW_FILES)
 $(BUILD_DIR)/src/game/crash_screen.o: $(CRASH_TEXTURE_C_FILES)
@@ -757,7 +762,7 @@ $(ROM): $(ELF)
 $(BUILD_DIR)/$(TARGET).objdump: $(ELF)
 	$(OBJDUMP) -D $< > $@
 
-.PHONY: all clean distclean default diff test load
+.PHONY: all clean distclean default diff test load patch
 # with no prerequisites, .SECONDARY causes no intermediate target to be removed
 .SECONDARY:
 
diff --git a/tools/Flips b/tools/Flips
new file mode 160000
index 00000000..886ad64c
--- /dev/null
+++ b/tools/Flips
@@ -0,0 +1 @@
+Subproject commit 886ad64c691edc2d1b3288bd8693d4331dddc038
diff --git a/tools/Makefile b/tools/Makefile
index df001cf8..f7981a30 100644
--- a/tools/Makefile
+++ b/tools/Makefile
@@ -69,9 +69,13 @@ all-except-recomp: $(LIBAUDIOFILE) $(BUILD_PROGRAMS)
 
 all: all-except-recomp
 
+flips:
+	@$(MAKE) -C Flips
+
 clean:
 	$(RM) $(ALL_PROGRAMS)
 	$(MAKE) -C audiofile clean
+	$(MAKE) -C Flips clean
 
 define COMPILE
 $(1): $($1_SOURCES)
@@ -83,4 +87,4 @@ $(foreach p,$(BUILD_PROGRAMS),$(eval $(call COMPILE,$(p))))
 $(LIBAUDIOFILE):
 	@$(MAKE) -C audiofile
 
-.PHONY: all all-except-recomp clean default
+.PHONY: all all-except-recomp clean flips default

From 077c29ed23633cdd529dec99566b6e5a3cf8ea86 Mon Sep 17 00:00:00 2001
From: thecozies <collinpferguson@gmail.com>
Date: Tue, 20 Jul 2021 18:32:39 -0500
Subject: [PATCH 2/4] automatically build flips with other tool dependencies

---
 tools/Makefile | 11 ++++++-----
 1 file changed, 6 insertions(+), 5 deletions(-)

diff --git a/tools/Makefile b/tools/Makefile
index f7981a30..40344264 100644
--- a/tools/Makefile
+++ b/tools/Makefile
@@ -9,6 +9,7 @@ CFLAGS       := -I. -O2 -s
 LDFLAGS      := -lm
 ALL_PROGRAMS := armips filesizer rncpack n64graphics n64graphics_ci mio0 slienc n64cksum textconv patch_elf_32bit aifc_decode aiff_extract_codebook vadpcm_enc tabledesign extract_data_for_mio skyconv
 LIBAUDIOFILE := audiofile/libaudiofile.a
+FLIPS        := Flips/flips
 
 # Only build armips from tools if it is not found on the system
 ifeq ($(call find-command,armips),)
@@ -65,13 +66,10 @@ ifeq ($(HOST_ENV),MinGW)
   armips_LDFLAGS += -municode
 endif
 
-all-except-recomp: $(LIBAUDIOFILE) $(BUILD_PROGRAMS)
+all-except-recomp: $(LIBAUDIOFILE) $(FLIPS) $(BUILD_PROGRAMS)
 
 all: all-except-recomp
 
-flips:
-	@$(MAKE) -C Flips
-
 clean:
 	$(RM) $(ALL_PROGRAMS)
 	$(MAKE) -C audiofile clean
@@ -87,4 +85,7 @@ $(foreach p,$(BUILD_PROGRAMS),$(eval $(call COMPILE,$(p))))
 $(LIBAUDIOFILE):
 	@$(MAKE) -C audiofile
 
-.PHONY: all all-except-recomp clean flips default
+$(FLIPS):
+	@$(MAKE) -C Flips
+
+.PHONY: all all-except-recomp clean default

From ca570ba4d3b65e5a9559208b3c728d76cf9a0866 Mon Sep 17 00:00:00 2001
From: thecozies <collinpferguson@gmail.com>
Date: Tue, 20 Jul 2021 18:42:11 -0500
Subject: [PATCH 3/4] Explain make patch in README

---
 README.md | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/README.md b/README.md
index 42e6b56c..12ba25d8 100644
--- a/README.md
+++ b/README.md
@@ -70,6 +70,9 @@ This is not recommended as it increases ROM size significantly, with little poin
 To switch to no compression, run make with the ``COMPRESS=uncomp`` argument.
 
 
+## Creating patches
+You can create a bps patch after building by using `make patch`. This will be located in the build directory under the same `TARGET_STRING` as your rom build.
+
 ## FAQ
 
 Q: Why in the hell are you bundling your own build of ``ld``?

From 5400a2786eca3b0dc22dcb187580141d9fae8a25 Mon Sep 17 00:00:00 2001
From: thecozies <collinpferguson@gmail.com>
Date: Wed, 21 Jul 2021 05:57:23 -0500
Subject: [PATCH 4/4] make sure rom is built before patching, removed building
 flips manually, print SHA1

---
 Makefile | 4 ++--
 1 file changed, 2 insertions(+), 2 deletions(-)

diff --git a/Makefile b/Makefile
index 126ab9f8..d3df3157 100644
--- a/Makefile
+++ b/Makefile
@@ -496,9 +496,9 @@ load: $(ROM)
 
 libultra: $(BUILD_DIR)/libultra.a
 
-patch:
-	@$(MAKE) -C $(TOOLS_DIR) flips
+patch: $(ROM)
 	$(FLIPS) --create --bps ./baserom.$(VERSION).z64 $(ROM) $(BUILD_DIR)/$(TARGET_STRING).bps
+	@$(SHA1SUM) $(ROM)
 
 # Extra object file dependencies
 $(BUILD_DIR)/asm/boot.o:              $(IPL3_RAW_FILES)